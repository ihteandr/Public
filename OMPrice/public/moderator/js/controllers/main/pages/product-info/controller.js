define(["jquery","Lodash","moment"],function(t,r,e){return["$scope","$routeParams","ProductInfoService","SpinService",function(n,c,o,u){function i(){o.getSections(n.currentProduct.market).then(function(t){n.sections=t;var e=r.find(n.sections,function(t){return t._id==n.currentProduct.section});e||(n.currentProduct.section="",n.currentProduct.category="",n.currentProduct.family="")},App.errorHandler)}function a(){return""==n.currentProduct.section?(n.categories=[],void(n.currentProduct.family="")):void o.getCategories(n.currentProduct.section).then(function(t){n.categories=t;var e=r.find(n.categories,function(t){return t._id==n.currentProduct.category});e||(n.currentProduct.category="",n.currentProduct.family="")},App.errorHandler)}function d(){return""==n.currentProduct.category?void(n.families=[]):void o.getFamilies(n.currentProduct.category).then(function(t){n.families=t},App.errorHandler)}function s(){var r=["family","section","category","market"],e=!0;n.product.ean||n.tmpProduct.ean?t("#ean").removeClass("error"):(t("#ean").addClass("error"),e=!1);for(var c=0,o=r.length;o>c;c++)n.currentProduct[r[c]]?t("#"+r[c]).removeClass("error"):(t("#"+r[c]).addClass("error"),e=!1);return e}var l=!1;if(n.currentProduct={isNotInitialized:!0},c.idOrEanOrName){var p=c.idOrEanOrName,m={};/^[\d,]+$/.test(p)?m.ean=p:/^([a-z]|[0-9])+$/.test(p)?m._id=p:m.name=p,setTimeout(function(){u.startSpin(t("form.not-initialized")[0])},200),o.getProduct(m).then(function(t){var c;n.product=t,n.product?(c=n.product.ean,r.each(t.prices,function(t){t.date=e(t.date,"DD/MM/YY")})):m.ean?(n.product={details:{nutritional:{}}},c=m.ean):App.errorHandler(new Error("Page not available")),o.getTmpProduct(c).then(function(t){t&&t.product?(l=!0,n.tmpProduct=t.product,n.currentProduct=n.tmpProduct):(n.tmpProduct={},n.currentProduct=n.product),n.currentProduct.images=n.product.images||[],o.getMarkets().then(function(t){u.stopSpin(),n.markets=t},App.errorHandler)},App.errorHandler)},App.errorHandler)}else n.currentProduct={ean:null,details:{nutritional:{}}},n.product={ean:null,details:{nutritional:{}}},n.tmpProduct={},o.getMarkets().then(function(t){n.markets=t},App.errorHandler);n.newImages=[],n.$watch("currentProduct.market",function(t,r){t!==r&&(i(),a(),d())}),n.$watch("currentProduct.section",function(t,r){t!==r&&(a(),d())}),n.$watch("currentProduct.category",function(t,r){t!==r&&d()}),o.getCountries().then(function(t){n.countries=t},App.errorHandler),o.getBrands().then(function(t){n.brands=t},App.errorHandler),o.getBulkUnits().then(function(t){n.bulkUnits=t},App.errorHandler),n.submit=function(){s()&&(console.log("new Images ",n.newImages),o.saveProduct({product:n.currentProduct,newImages:n.newImages},l).then(function(r){n.product=n.currentProduct,n.tmpProduct={ean:""},n.product.images=r.images,n.newImages=[],n.$broadcast("resetUpl0oader"),t.growl({message:"Изменения Сохранены"},{type:"success"}),l=!1},App.errorHandler))},n.back=function(){App.navigate("/home")},n.checkName=function(){return n.tmpProduct.name&&n.product.name!=n.tmpProduct.name?!0:!1},n.checkMarket=function(){return n.tmpProduct.market&&n.product.market!=n.tmpProduct.market?!0:!1},n.checkSection=function(){return n.tmpProduct.section&&n.product.section!=n.tmpProduct.section?!0:!1},n.checkCategory=function(){return n.tmpProduct.category&&n.product.category!=n.tmpProduct.category?!0:!1},n.checkFamily=function(){return n.tmpProduct.family&&n.product.family!=n.tmpProduct.family?!0:!1},n.checkDetailsBulk=function(){return n.tmpProduct.details&&n.product.details.bulk!=n.tmpProduct.details.bulk?!0:!1},n.checkDetailsBulkUnit=function(){return n.tmpProduct.details&&n.product.details.bulkUnit!=n.tmpProduct.details.bulkUnit?!0:!1},n.checkDetailsBrandName=function(){if(n.tmpProduct.details){if(!n.product.details.brand&&!n.tmpProduct.details.brand)return!1;if(!n.product.details.brand&&n.tmpProduct.details.brand)return!0;if(n.product.details.brand.name!=n.tmpProduct.details.brand.name)return!0}return!1},n.checkDetailsManufacturer=function(){return n.tmpProduct.details&&n.product.details.manufacturer!=n.tmpProduct.details.manufacturer?!0:!1},n.checkDetailsCountry=function(){if(n.tmpProduct.details){if(!n.product.details.country&&!n.tmpProduct.details.country)return!1;if(!n.product.details.country&&n.tmpProduct.details.country)return!0;if(n.product.details.country._id!=n.tmpProduct.details.country._id)return!0}return!1},n.checkDetailsAddress=function(){return n.tmpProduct.details&&n.product.details.address!=n.tmpProduct.details.address?!0:!1},n.checkDetailsWebsite=function(){return n.tmpProduct.details&&n.product.details.website!=n.tmpProduct.details.website?!0:!1},n.checkDetailsPhone=function(){return n.tmpProduct.details&&n.product.details.phone!=n.tmpProduct.details.phone?!0:!1},n.checkDetailsEmail=function(){return n.tmpProduct.details&&n.product.details.email!=n.tmpProduct.details.email?!0:!1},n.checkDetailsSummary=function(){return n.tmpProduct.details&&n.product.details.summary!=n.tmpProduct.details.summary?!0:!1},n.checkDetailsConsist=function(){return n.tmpProduct.details&&n.product.details.consist!=n.tmpProduct.details.consist?!0:!1},n.checkDetailsNutritionalFat=function(){return n.tmpProduct.details&&n.product.details.nutritional.fat!=n.tmpProduct.details.nutritional.fat?!0:!1},n.checkDetailsNutritionalProtein=function(){return n.tmpProduct.details&&n.product.details.nutritional.protein!=n.tmpProduct.details.nutritional.protein?!0:!1},n.checkDetailsNutritionalCarbohydrates=function(){return n.tmpProduct.details&&n.product.details.nutritional.carbohydrates!=n.tmpProduct.details.nutritional.carbohydrates?!0:!1},n.checkDetailsNutritionalCaloric=function(){return n.tmpProduct.details&&n.product.details.nutritional.caloric!=n.tmpProduct.details.nutritional.caloric?!0:!1},n.checkStatus=function(){return n.tmpProduct.status&&n.product.status!=n.tmpProduct.status?!0:!1}}]});